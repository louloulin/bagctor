<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bactor Monitoring Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            padding: 0 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dashboard-controls {
            display: flex;
            gap: 10px;
        }

        .dashboard-info {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .dashboard-info span {
            margin-right: 15px;
            font-weight: bold;
        }

        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .metric-card h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .metric-card .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;
            color: #3498db;
        }

        .metric-card .metric-info {
            font-size: 12px;
            color: #7f8c8d;
        }

        .metric-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .metric-tag {
            background-color: #e0f7fa;
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 11px;
            color: #0097a7;
        }

        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: none;
            border-radius: 4px 4px 0 0;
        }

        .tab.active {
            background-color: #2c3e50;
            color: white;
            border-bottom: 2px solid #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .system-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .system-metric {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .system-metric h3 {
            margin-top: 0;
            font-size: 14px;
            color: #7f8c8d;
        }

        .system-metric .value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #2980b9;
        }

        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1>Bactor Monitoring Dashboard</h1>
        </div>
    </header>

    <div class="container">
        <div class="dashboard-header">
            <h2>System Overview</h2>
            <div class="dashboard-controls">
                <select id="refresh-interval">
                    <option value="5000">Refresh: 5s</option>
                    <option value="10000">Refresh: 10s</option>
                    <option value="30000">Refresh: 30s</option>
                    <option value="60000">Refresh: 1m</option>
                </select>
                <button id="refresh-btn">Refresh Now</button>
            </div>
        </div>

        <div class="dashboard-info">
            <span id="metrics-count">Total Metrics: --</span>
            <span id="last-update">Last Update: --</span>
            <span id="uptime">Uptime: --</span>
        </div>

        <div class="system-metrics">
            <div class="system-metric">
                <h3>Active Actors</h3>
                <div class="value" id="active-actors">--</div>
            </div>
            <div class="system-metric">
                <h3>Messages/sec</h3>
                <div class="value" id="message-rate">--</div>
            </div>
            <div class="system-metric">
                <h3>Error Rate</h3>
                <div class="value" id="error-rate">--</div>
            </div>
            <div class="system-metric">
                <h3>CPU Usage</h3>
                <div class="value" id="cpu-usage">--</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="counters">Counters</button>
            <button class="tab" data-tab="gauges">Gauges</button>
            <button class="tab" data-tab="histograms">Histograms</button>
            <button class="tab" data-tab="meters">Meters</button>
        </div>

        <div id="counters" class="tab-content active">
            <div class="chart-container">
                <canvas id="counters-chart"></canvas>
            </div>
            <div class="metrics-container" id="counters-container">
                <!-- Counter metrics will be inserted here -->
            </div>
        </div>

        <div id="gauges" class="tab-content">
            <div class="chart-container">
                <canvas id="gauges-chart"></canvas>
            </div>
            <div class="metrics-container" id="gauges-container">
                <!-- Gauge metrics will be inserted here -->
            </div>
        </div>

        <div id="histograms" class="tab-content">
            <div class="chart-container">
                <canvas id="histograms-chart"></canvas>
            </div>
            <div class="metrics-container" id="histograms-container">
                <!-- Histogram metrics will be inserted here -->
            </div>
        </div>

        <div id="meters" class="tab-content">
            <div class="chart-container">
                <canvas id="meters-chart"></canvas>
            </div>
            <div class="metrics-container" id="meters-container">
                <!-- Meter metrics will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Dashboard configuration
        const config = {
            apiEndpoint: '/metrics',
            refreshInterval: 5000,
            startTime: Date.now()
        };

        // State for storing metrics history
        const metricsHistory = {
            counters: {},
            gauges: {},
            histograms: {},
            meters: {}
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            refreshDashboard();
            setInterval(refreshDashboard, config.refreshInterval);
        });

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');

                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Show selected tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.toggle('active', content.id === tabId);
                    });
                });
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', refreshDashboard);

            // Refresh interval dropdown
            document.getElementById('refresh-interval').addEventListener('change', function () {
                config.refreshInterval = parseInt(this.value);
                // Clear existing interval and set new one
                if (window.refreshIntervalId) {
                    clearInterval(window.refreshIntervalId);
                }
                window.refreshIntervalId = setInterval(refreshDashboard, config.refreshInterval);
            });
        }

        async function refreshDashboard() {
            try {
                const response = await fetch(config.apiEndpoint);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                updateDashboardInfo(data);
                updateSystemMetrics(data);
                updateMetricContainers(data);

                // Store metrics history for charts
                storeMetricsHistory(data);

                // Update charts
                updateCharts();

            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }

        function updateDashboardInfo(data) {
            document.getElementById('metrics-count').textContent = `Total Metrics: ${data.count}`;
            document.getElementById('last-update').textContent = `Last Update: ${new Date().toLocaleTimeString()}`;

            // Calculate uptime
            const uptime = Math.floor((Date.now() - config.startTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            document.getElementById('uptime').textContent = `Uptime: ${hours}h ${minutes}m ${seconds}s`;
        }

        function updateSystemMetrics(data) {
            // Find system metrics
            const activeActorsMetric = findMetric(data.metrics, 'bactor_active_actors');
            const messageRateMetric = findMetric(data.metrics, 'bactor_message_delivery_rate');
            const errorRateMetric = findMetric(data.metrics, 'bactor_error_rate');

            // Update UI
            document.getElementById('active-actors').textContent = activeActorsMetric ? activeActorsMetric.value : '--';
            document.getElementById('message-rate').textContent = messageRateMetric
                ? `${messageRateMetric.value.m1Rate.toFixed(2)}`
                : '--';
            document.getElementById('error-rate').textContent = errorRateMetric
                ? `${(errorRateMetric.value.m1Rate * 100).toFixed(2)}%`
                : '--';

            // CPU usage would typically come from a system metric
            // This is a placeholder - real implementation would use actual CPU metrics
            document.getElementById('cpu-usage').textContent = Math.floor(Math.random() * 30) + '%';
        }

        function updateMetricContainers(data) {
            const metricsByType = data.byType || {};

            // Update counters
            updateMetricContainer('counters-container', metricsByType.counter || [], formatCounterValue);

            // Update gauges
            updateMetricContainer('gauges-container', metricsByType.gauge || [], formatGaugeValue);

            // Update histograms
            updateMetricContainer('histograms-container', metricsByType.histogram || [], formatHistogramValue);

            // Update meters
            updateMetricContainer('meters-container', metricsByType.meter || [], formatMeterValue);
        }

        function updateMetricContainer(containerId, metrics, formatValueFn) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = 'metric-card';

                const tags = Object.entries(metric.tags)
                    .map(([key, value]) => `<span class="metric-tag">${key}: ${value}</span>`)
                    .join('');

                card.innerHTML = `
                    <h3>${metric.name}</h3>
                    <div class="metric-value">${formatValueFn(metric.value)}</div>
                    <div class="metric-info">${metric.help}</div>
                    <div class="metric-tags">${tags}</div>
                `;

                container.appendChild(card);
            });
        }

        function formatCounterValue(value) {
            return value.toLocaleString();
        }

        function formatGaugeValue(value) {
            return value.toLocaleString();
        }

        function formatHistogramValue(value) {
            return `avg: ${(value.sum / value.count).toFixed(2)}, count: ${value.count}`;
        }

        function formatMeterValue(value) {
            return `${value.m1Rate.toFixed(2)}/s`;
        }

        function findMetric(metrics, name) {
            return metrics.find(m => m.name === name);
        }

        function storeMetricsHistory(data) {
            const timestamp = Date.now();

            // Store data by type for time-series charts
            (data.byType.counter || []).forEach(metric => {
                if (!metricsHistory.counters[metric.name]) {
                    metricsHistory.counters[metric.name] = [];
                }
                metricsHistory.counters[metric.name].push({
                    timestamp,
                    value: metric.value
                });

                // Keep only last 100 points
                if (metricsHistory.counters[metric.name].length > 100) {
                    metricsHistory.counters[metric.name].shift();
                }
            });

            // Same for other types
            (data.byType.gauge || []).forEach(metric => {
                if (!metricsHistory.gauges[metric.name]) {
                    metricsHistory.gauges[metric.name] = [];
                }
                metricsHistory.gauges[metric.name].push({
                    timestamp,
                    value: metric.value
                });
                if (metricsHistory.gauges[metric.name].length > 100) {
                    metricsHistory.gauges[metric.name].shift();
                }
            });

            (data.byType.meter || []).forEach(metric => {
                if (!metricsHistory.meters[metric.name]) {
                    metricsHistory.meters[metric.name] = [];
                }
                metricsHistory.meters[metric.name].push({
                    timestamp,
                    value: metric.value.m1Rate
                });
                if (metricsHistory.meters[metric.name].length > 100) {
                    metricsHistory.meters[metric.name].shift();
                }
            });
        }

        function updateCharts() {
            // This function would update charts using a charting library
            // For this example, we're leaving it as a placeholder
            // In a real implementation, you'd use Chart.js, D3.js, or similar
            console.log('Charts would be updated here with history data');
        }
    </script>
</body>

</html>